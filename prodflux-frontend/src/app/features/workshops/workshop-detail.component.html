<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
<div class="page-container">
  <div class="workshop-container" *ngIf="!isLoading && workshop">
    <mat-card class="workshop-header">
      <mat-card-title>{{ workshop.name }}</mat-card-title>

      <app-product-overview
      [products]="productLifecycle"
      (planMultiOrder)="openMultiOrderModal()"
      (openOrder)="openOrderModal($event)"
      (openSell)="openSellDialog($event)"
      (manufacture)="manufactureProductFromChild($event)"
    ></app-product-overview>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>Aktueller Materialbestand</span>
            <div class="header-toggles" (click)="$event.stopPropagation()">
              <mat-slide-toggle
                [checked]="(inventoryService.state$ | async)?.isActive || false"
                (change)="onInventoryModeToggle()"
                color="primary"
                class="inventory-toggle-inline"
              >
                Inventur
              </mat-slide-toggle>
              <mat-slide-toggle 
                [(ngModel)]="includeDeprecatedMaterials"
                (ngModelChange)="onToggleDeprecatedMaterials()"
                color="accent"
                class="deprecated-toggle-inline"
              >
                Veraltete anzeigen
              </mat-slide-toggle>
            </div>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Inventur-Aktionen (nur wenn Inventurmodus aktiv) -->
        <app-inventory-controls
          [inventoryModeActive]="(inventoryService.state$ | async)?.isActive || false"
          [navigationModeActive]="(inventoryService.state$ | async)?.isNavigationMode || false"
          [materialCount]="allMaterials.length"
          [unsavedCount]="getUnsavedInventoryCount()"
          [showToggle]="false"
          (inventoryModeToggled)="onInventoryModeToggle()"
          (navigationStarted)="onStartInventoryNavigation()"
          (saveAllRequested)="onSaveAllInventoryCorrections()"
        ></app-inventory-controls>

        <!-- Material Inventory Table -->
        <app-material-inventory-table
          [materialGroups]="stock"
          [inventoryModeActive]="(inventoryService.state$ | async)?.isActive || false"
          [inventoryCounts]="(inventoryService.state$ | async)?.inventoryCounts || {}"
          [savedMaterialIds]="(inventoryService.state$ | async)?.savedMaterialIds || emptySavedMaterialIds"
          (inventoryCountChanged)="onInventoryCountChange($event)"
          (saveCorrectionRequested)="onSaveCorrection($event)"
        ></app-material-inventory-table>

      </mat-expansion-panel>
    </mat-card>

    <!-- Modal für Material Bestellung mehrerer Produkte-->

    <ng-template #multiOrderDialog let-dialog>
      <h2 mat-dialog-title>Materialbedarf planen und bestellen</h2>
      <mat-dialog-content class="multi-dialog-content">

        <!-- Produktmenge pro Produkt -->
        <table class="full-width-table">
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Menge</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of multiOrderProducts">
              <td>{{ entry.product }}</td>
              <td>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    type="number"
                    min="0"
                    [(ngModel)]="entry.quantity"
                    (ngModelChange)="loadAggregatedRequirements()"
                  />
                </mat-form-field>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Fehlende Materialien -->
        <h3 class="mt-4">Fehlende Materialien</h3>
        <table class="full-width-table mt-2">
          <thead>
            <tr>
              <th>Bild</th>
              <th>Material</th>
              <th>Benötigt</th>
              <th>Bestellt</th>
              <th>Vorhanden</th>
              <th>Fehlend</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!filteredMissingRequirements.length">
              <td colspan="6" class="text-center text-gray-500 py-2">
                Keine fehlenden Materialien.
              </td>
            </tr>
            <tr *ngFor="let req of filteredMissingRequirements">
              <td>
                <img
                  *ngIf="req.bild_url"
                  [src]="req.bild_url"
                  alt="{{ req.bezeichnung }}"
                  class="table-image small"
                />
              </td>
              <td>{{ req.bezeichnung }}</td>
              <td>{{ req.required_quantity }}</td>
              <td>{{ req.ordered_quantity }}</td>
              <td>{{ req.available_quantity }}</td>
              <td>{{ req.missing_quantity }}</td>
            </tr>
          </tbody>
        </table>

        <!-- Bereits gedeckte Materialien -->
        <h3 class="mt-6">Bereits gedeckte Materialien</h3>
        <table class="full-width-table mt-2">
          <thead>
            <tr>
              <th>Bild</th>
              <th>Material</th>
              <th>Benötigt</th>
              <th>Bestellt</th>
              <th>Vorhanden</th>
              <th>Fehlend</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!filteredCoveredRequirements.length">
              <td colspan="6" class="text-center text-gray-500 py-2">
                Keine vollständig gedeckten Materialien.
              </td>
            </tr>
            <tr *ngFor="let req of filteredCoveredRequirements">
              <td>
                <img
                  *ngIf="req.bild_url"
                  [src]="req.bild_url"
                  alt="{{ req.bezeichnung }}"
                  class="table-image small"
                />
              </td>
              <td>{{ req.bezeichnung }}</td>
              <td>{{ req.required_quantity }}</td>
              <td>{{ req.ordered_quantity }}</td>
              <td>{{ req.available_quantity }}</td>
              <td>{{ req.missing_quantity }}</td>
            </tr>
          </tbody>
        </table>

      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Schließen</button>
        <button
          mat-raised-button
          color="primary"
          [disabled]="!filteredMissingRequirements.length"
          (click)="confirmAggregatedOrder(dialog)"
        >
          Bestellen
        </button>
      </mat-dialog-actions>
    </ng-template>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Werkstatt wird geladen...</p>
  </div>

  <!-- Workshop not found State -->
  <div *ngIf="!isLoading && !workshop" class="error-container">
    <p class="error-text">Werkstatt nicht gefunden.</p>
  </div>

  <!-- Inventur-Navigator Widget -->
  <app-inventory-navigator
    [isVisible]="(inventoryService.state$ | async)?.isNavigationMode || false"
    [currentMaterial]="getCurrentMaterial()"
    [inventoryCount]="getCurrentInventoryCount()"
    [canGoToNext]="canGoToNextMaterial()"
    [canGoToPrevious]="canGoToPreviousMaterial()"
    (navigation)="onNavigation($event)"
    (saveAndNext)="onSaveAndNext($event)"
    (finishInventory)="onFinishInventory()"
    (inventoryCountChanged)="onInventoryCountChanged($event)"
  ></app-inventory-navigator>


</div>
