<div class="material-planner-container">
  <div class="header">
    <h1>Materialplanung</h1>
    <p class="description">
      Planen Sie global den Materialbedarf für Ihre Produktionsziele.
      Das System berechnet automatisch erforderliche Bestellungen nach Rauen und
      plant anschließende Transfers zwischen Werkstätten.
    </p>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="!(planningData$ | async)">
    <mat-spinner></mat-spinner>
    <p>Lade Daten...</p>
  </div>

  <!-- Content (loaded) -->
  <div class="content-layout" *ngIf="planningData$ | async as planningData">
    <!-- Input Form Section -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Produktionsziele</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <app-material-planner-targets-form
          [products]="(productsForForm$ | async) || []"
          [workshops]="(workshopsForForm$ | async) || []"
          (targetsChange)="onTargetsChange($event)">
        </app-material-planner-targets-form>

        <div class="calculate-button-container">
          <button mat-raised-button color="primary" (click)="calculatePlan(planningData)"
                  [disabled]="targets.length === 0">
            Plan berechnen
          </button>
        </div>

        <!-- Error display -->
        <div class="error-message" *ngIf="error">
          <mat-card appearance="outlined" class="error-card">
            <mat-card-content>
              <p class="error-text">{{ error }}</p>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Results Tabs Section -->
    <mat-card class="results-section">
      <mat-card-header>
        <mat-card-title>Planungsergebnisse</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="no-result-hint" *ngIf="!planningResult">
          <p>Bitte Produktziele erfassen und Plan berechnen.</p>
        </div>

        <mat-tab-group *ngIf="planningResult">
          <mat-tab label="Globaler Bedarf & Bestellungen">
            <app-global-demand-orders-tab
              [rows]="planningResult.materials"
              [materialById]="planningData.lookups.materialById"
              (createOrder)="createOrderFromPlan()">
            </app-global-demand-orders-tab>
          </mat-tab>

          <mat-tab label="Transfers nach Lieferung">
            <app-transfer-plan-tab
              [materials]="planningResult.materials"
              [transfers]="planningResult.transferSuggestions"
              [coverage]="planningResult.workshopCoverage"
              [workshopById]="planningData.lookups.workshopById"
              [materialById]="planningData.lookups.materialById"
              [workshopIds]="planningResult.meta.workshopIds"
              [centralWorkshopId]="planningResult.meta.centralWorkshopId"
              (adoptTodos)="adoptTransferTodos(planningData)">
            </app-transfer-plan-tab>
          </mat-tab>

          <mat-tab label="Deckung pro Werkstatt">
            <app-workshop-coverage-tab
              [coverage]="planningResult.workshopCoverage"
              [workshopById]="planningData.lookups.workshopById"
              [materialById]="planningData.lookups.materialById"
              [workshopIds]="planningResult.meta.workshopIds">
            </app-workshop-coverage-tab>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>

    <!-- Transfer ToDos Overview -->
    @if (transferTodos.length > 0) {
      <mat-card class="todos-section">
        <mat-card-header>
          <mat-card-title>Transfer-Übersicht (ToDos)</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="transferTodos" class="todos-table">
            <!-- Material Column -->
            <ng-container matColumnDef="material">
              <th mat-header-cell *matHeaderCellDef>Material</th>
              <td mat-cell *matCellDef="let todo">{{ todo.materialName }}</td>
            </ng-container>

            <!-- From/To Column -->
            <ng-container matColumnDef="fromTo">
              <th mat-header-cell *matHeaderCellDef>Von → Nach</th>
              <td mat-cell *matCellDef="let todo">
                {{ todo.fromWorkshopName }} → {{ todo.toWorkshopName }}
              </td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Menge</th>
              <td mat-cell *matCellDef="let todo">{{ todo.quantity | number:'1.0-2' }}</td>
            </ng-container>

            <!-- Done Column -->
            <ng-container matColumnDef="done">
              <th mat-header-cell *matHeaderCellDef>Erledigt</th>
              <td mat-cell *matCellDef="let todo">
                <mat-checkbox [(ngModel)]="todo.done" (change)="toggleTodoDone(todo.id)">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Aktionen</th>
              <td mat-cell *matCellDef="let todo">
                <button mat-icon-button color="warn" type="button" (click)="deleteTodo(todo.id)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="todosDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: todosDisplayedColumns;" [class.completed]="row.done"></tr>
          </table>

          <div class="backend-note">
            <strong>Backend Integration (Step 7):</strong>
            <button mat-raised-button color="primary" type="button"
                    (click)="createTransfersFromTodos()"
                    [disabled]="isCreatingTransfers">
              {{ isCreatingTransfers ? 'Erstelle Transfers...' : 'Alle offenen Transfers im Backend anlegen' }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>
</div>
