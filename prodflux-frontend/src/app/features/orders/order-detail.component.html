<div class="page-container">
  <app-breadcrumb
    [links]="[
      { label: 'Bestellungen', url: '/orders' },
      { label: 'Bestellung #' + order?.id, url: '/orders/' + order?.id }
    ]"
  ></app-breadcrumb>

  <mat-card class="order-detail-card" *ngIf="order">
    <mat-card-title>Bestellung #{{ order.id }}</mat-card-title>

    <div class="detail-actions">
      <button mat-stroked-button color="primary" [routerLink]="['/orders', order.id, 'edit']">
        <mat-icon>edit</mat-icon> Bearbeiten
      </button>
      <button mat-raised-button color="accent" [routerLink]="['/deliveries/new']" [queryParams]="{orderId: order.id}">
        <mat-icon>local_shipping</mat-icon> Lieferung hinzufügen
      </button>
      <button mat-stroked-button color="warn" (click)="deleteOrder()">
        <mat-icon>delete</mat-icon> Löschen
      </button>
    </div>

    <p><strong>Bestellt am:</strong> {{ formatDate(order.bestellt_am) }}</p>
    <p><strong>Angekommen am:</strong> {{ formatDate(order.angekommen_am) }}</p>
    <p *ngIf="getSupplier(order.supplier)">
      <strong>Lieferant:</strong>
      <a [routerLink]="['/suppliers', order.supplier]" class="supplier-link">
        <mat-icon class="link-icon">business</mat-icon>
        {{ getSupplier(order.supplier)?.name }}
      </a>
    </p>
    <div class="versandkosten-section">
      <p>
        <strong>Versandkosten (netto):</strong> {{ formatCurrency(order.versandkosten) }}
      </p>
      <p>
        <strong>MwSt.-Satz:</strong> {{ order.versandkosten_mwst_satz ?? 19 }}%
      </p>
      <p>
        <strong>Versandkosten (brutto):</strong> {{ formatCurrency(calculateBrutto(order.versandkosten ?? 0, order.versandkosten_mwst_satz)) }}
      </p>
    </div>
    <p><strong>Notiz:</strong> {{ order.notiz || "—" }}</p>
    <p *ngIf="order.is_historical" class="historical-notice">
      <mat-icon class="historical-icon">history</mat-icon>
      <strong>Historische Bestellung</strong> - Diese Bestellung hat keine Auswirkung auf den Materialbestand
    </p>

    <div class="mt-4">
      <h3>Bestellte Materialien</h3>

      <app-material-table
        [rows]="getMaterialTableRows()"
        [columns]="materialTableColumns"
        [showImage]="true"
        [showCategory]="true">
        <ng-template #customColumn let-row let-column="column">
          @switch (column.key) {
            @case ('quantity') {
              {{ row.data.quantity | number:'1.0-2' }}
            }
            @case ('preis') {
              {{ formatCurrency(row.data.preis) }}
            }
            @case ('mwst') {
              {{ row.data.mwst }}%
            }
            @case ('gesamt_netto') {
              {{ formatCurrency(row.data.gesamt_netto) }}
            }
            @case ('brutto') {
              {{ formatCurrency(row.data.brutto) }}
            }
            @case ('gesamt_brutto') {
              <strong>{{ formatCurrency(row.data.gesamt_brutto) }}</strong>
            }
            @case ('artikelnummer') {
              {{ row.data.artikelnummer }}
            }
          }
        </ng-template>
      </app-material-table>
    </div>

    <!-- NEW: Deliveries Section -->
    <div class="mt-4" *ngIf="deliveries.length > 0">
      <h3>Zugehörige Lieferungen</h3>
      <table mat-table [dataSource]="deliveries" class="mat-elevation-z1 full-width-table">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let d">{{ d.id }}</td>
        </ng-container>

        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Datum</th>
          <td mat-cell *matCellDef="let d">{{ formatDateTime(d.created_at) }}</td>
        </ng-container>

        <ng-container matColumnDef="note">
          <th mat-header-cell *matHeaderCellDef>Notiz</th>
          <td mat-cell *matCellDef="let d">{{ d.note || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Aktionen</th>
          <td mat-cell *matCellDef="let d">
            <button mat-icon-button [routerLink]="['/deliveries', d.id]" matTooltip="Details anzeigen">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['id', 'created_at', 'note', 'actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['id', 'created_at', 'note', 'actions']"></tr>
      </table>
    </div>
  </mat-card>
</div>
