<div class="workshop-container" *ngIf="workshop">
  <mat-card class="workshop-header">
    <mat-card-title>{{ workshop.name }}</mat-card-title>

    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Produktübersicht</mat-panel-title>
      </mat-expansion-panel-header>

      <table mat-table [dataSource]="productLifecycle" class="mat-elevation-z1 full-width-table mt-2">
        <ng-container matColumnDef="nr">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let element; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef>Produkt</th>
          <td mat-cell *matCellDef="let element">{{ element.product }}</td>
        </ng-container>

        <ng-container matColumnDef="with_ordered_material">
          <th mat-header-cell *matHeaderCellDef>Fertigbar (inkl. bestelltem Material)</th>
          <td mat-cell *matCellDef="let element">{{ element.bestellungen_moeglich }}</td>
        </ng-container>

        <ng-container matColumnDef="with_stock_material">
          <th mat-header-cell *matHeaderCellDef>Fertigbar (aus Lagerbestand)</th>
          <td mat-cell *matCellDef="let element">{{ element.lager_fertigung_moeglich }}</td>
        </ng-container>

        <ng-container matColumnDef="produced">
          <th mat-header-cell *matHeaderCellDef>Bereits gefertigt</th>
          <td mat-cell *matCellDef="let element">{{ element.bestand_fertig }}</td>
        </ng-container>

        <ng-container matColumnDef="sold">
          <th mat-header-cell *matHeaderCellDef>Verkauft</th>
          <td mat-cell *matCellDef="let element">{{ element.verkauft || 0 }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Aktionen</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button color="primary" (click)="openOrderModal(element)">
              <mat-icon>add_shopping_cart</mat-icon>
            </button>
            <button mat-icon-button color="accent" [routerLink]="['/deliveries/new']">
              <mat-icon>local_shipping</mat-icon>
            </button>
            <button mat-icon-button color="warn" [matMenuTriggerFor]="manufactureMenu" (click)="selectedProduct = element">
              <mat-icon>precision_manufacturing</mat-icon>
            </button>
            <button mat-icon-button (click)="openSellDialog(element)">
              <mat-icon>sell</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['nr', 'product', 'with_ordered_material', 'with_stock_material', 'produced', 'sold', 'actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['nr', 'product', 'with_ordered_material', 'with_stock_material', 'produced', 'sold', 'actions']"></tr>
      </table>
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Aktueller Materialbestand</mat-panel-title>
      </mat-expansion-panel-header>

      <table mat-table [dataSource]="stock" class="mat-elevation-z1 full-width-table mt-2">
        <ng-container matColumnDef="nr">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let element; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="bild">
          <th mat-header-cell *matHeaderCellDef>Bild</th>
          <td mat-cell *matCellDef="let element">
            <img *ngIf="element.bild_url" [src]="element.bild_url" alt="Bild" class="table-image" />
          </td>
        </ng-container>

        <ng-container matColumnDef="bezeichnung">
          <th mat-header-cell *matHeaderCellDef>Material</th>
          <td mat-cell *matCellDef="let element">
            <a [routerLink]="['/materials', element.material_id]">
              {{ element.bezeichnung }}
            </a>
          </td>
        </ng-container>

        <ng-container matColumnDef="bestand">
          <th mat-header-cell *matHeaderCellDef>Bestand</th>
          <td mat-cell *matCellDef="let element">{{ element.bestand }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </mat-expansion-panel>
  </mat-card>

  <!-- Modal für Bestellung -->
  <ng-template #orderDialog let-dialog>
    <h2 mat-dialog-title>Material für {{ selectedProduct?.product }} nachbestellen</h2>
    <mat-dialog-content>
      <p>Wie viele Einheiten sollen abgedeckt werden?</p>
      <mat-form-field>
        <input matInput type="number" [(ngModel)]="orderQty" (input)="loadOrderRequirements()">
      </mat-form-field>
      <table *ngIf="materialRequirements.length" class="full-width-table mt-2">
        <thead>
          <tr><th>Material</th><th>Benötigt</th><th>Vorhanden</th><th>Fehlend</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let req of materialRequirements">
            <td>{{ req.bezeichnung }}</td>
            <td>{{ req.required_quantity }}</td>
            <td>{{ req.available_quantity }}</td>
            <td>{{ req.missing_quantity }}</td>
          </tr>
        </tbody>
      </table>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button mat-dialog-close>Abbrechen</button>
      <button mat-raised-button color="primary" (click)="confirmOrder(dialog)">Bestellen</button>
    </mat-dialog-actions>
  </ng-template>

  <mat-menu #manufactureMenu="matMenu">
    <div class="menu-form">
      <p class="mb-1">Stückzahl für {{ selectedProduct?.product }}:</p>
      <mat-form-field appearance="outline">
        <input matInput type="number" min="1" [(ngModel)]="manufactureQty" />
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="manufactureProduct()">
        Bestätigen
      </button>
    </div>
  </mat-menu>
</div>

<div *ngIf="!workshop">
  <p class="text-center">Werkstatt nicht gefunden.</p>
</div>
