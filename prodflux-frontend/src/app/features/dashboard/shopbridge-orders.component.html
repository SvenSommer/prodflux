<!-- src/app/features/dashboard/shopbridge-orders.component.html -->
<div class="shopbridge-orders-page">

  <!-- Page Header -->
  <div class="page-header">
    <div class="header-title">
      <div class="shop-badge">
        <mat-icon>store</mat-icon>
        <span>WooCommerce</span>
      </div>
      <h1>
        <mat-icon>shopping_bag</mat-icon>
         Bestellungen
      </h1>
      <span class="subtitle">Bestellte Adapter über sdlink.de</span>
    </div>
    <div class="header-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="refresh()"
        [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Aktualisieren
      </button>
    </div>
  </div>

  <!-- Loading State (initial) -->
  <div *ngIf="loading && !data" class="loading-state">
    <mat-spinner diameter="48"></mat-spinner>
    <p>
      <span *ngIf="loadingPhase === 'stats'">Statistiken werden geladen...</span>
      <span *ngIf="loadingPhase === 'active'">Aktive Bestellungen werden geladen...</span>
    </p>
    <!-- Show stats while loading orders -->
    <div *ngIf="stats && !statsLoading" class="stats-preview">
      <span class="stats-badge">
        <mat-icon>receipt_long</mat-icon>
        {{ stats.total }} Bestellungen insgesamt
      </span>
      <span class="stats-detail">
        {{ stats.active }} aktiv • {{ stats.completed }} abgeschlossen • {{ stats.other }} andere
      </span>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <mat-icon>error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="refresh()">
      <mat-icon>refresh</mat-icon>
      Erneut versuchen
    </button>
  </div>

  <!-- Content -->
  <div *ngIf="data" class="orders-content">

    <!-- Loading More Banner -->
    <div *ngIf="loadingMore" class="loading-more-banner">
      <mat-spinner diameter="20"></mat-spinner>
      <span>
        <span *ngIf="loadingPhase === 'completed'">Abgeschlossene Bestellungen werden geladen...</span>
        <span *ngIf="loadingPhase === 'other'">Weitere Bestellungen werden geladen...</span>
      </span>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon orders">
            <mat-icon>receipt_long</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">
              {{ uniqueOrderIds }}
              <span *ngIf="stats && uniqueOrderIds < stats.total" class="stat-total">/ {{ stats.total }}</span>
            </span>
            <span class="stat-label">Bestellungen</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon adapters">
            <mat-icon>memory</mat-icon>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ totalAdapters }}</span>
            <span class="stat-label">Adapter gesamt</span>
          </div>
        </mat-card-content>
      </mat-card>


    </div>

    <!-- Quick Filters -->
    <div class="filters-section">
      <div class="filters-header">
        <mat-icon>filter_list</mat-icon>
        <span>Filter nach Status</span>
        <span *ngIf="loadingMore" class="loading-indicator">
          <mat-spinner diameter="16"></mat-spinner>
          Weitere werden geladen...
        </span>
      </div>
      <div class="filter-chips">
        <button
          mat-stroked-button
          [class.active]="activeStatusFilter === null"
          (click)="setStatusFilter(null)">
          <mat-icon>all_inclusive</mat-icon>
          Alle
          <span class="chip-count">
            {{ allOrders.length }}
            <span *ngIf="stats && allOrders.length < stats.total" class="chip-total">/ {{ stats.total }}</span>
          </span>
        </button>
        <button
          *ngFor="let filter of statusFilters"
          mat-stroked-button
          [class.active]="activeStatusFilter === filter.key"
          [style.--filter-color]="filter.color"
          (click)="setStatusFilter(filter.key)">
          <mat-icon [style.color]="filter.color">{{ filter.icon }}</mat-icon>
          {{ filter.label }}
          <span class="chip-count">
            {{ filter.count }}
            <span *ngIf="getStatCountForStatus(filter.key) > filter.count" class="chip-total">
              / {{ getStatCountForStatus(filter.key) }}
            </span>
          </span>
        </button>
      </div>
    </div>

    <!-- Orders Table -->
    <mat-card class="orders-table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list_alt</mat-icon>
          Bestellpositionen
          <span class="count-badge">{{ filteredOrders.length }}</span>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-wrapper">
          <table mat-table [dataSource]="filteredOrders" class="orders-table">

            <!-- Order ID Column -->
            <ng-container matColumnDef="orderId">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let order">
                <a [routerLink]="['/dashboard/shopbridge-orders', order.orderId]" class="order-link">
                  #{{ order.orderId }}
                </a>
              </td>
            </ng-container>

            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Datum</th>
              <td mat-cell *matCellDef="let order">
                <span class="date-cell">{{ formatDate(order.dateCreated) }}</span>
              </td>
            </ng-container>

            <!-- Customer Column -->
            <ng-container matColumnDef="customer">
              <th mat-header-cell *matHeaderCellDef>Kunde</th>
              <td mat-cell *matCellDef="let order">
                <span class="customer-name">{{ order.customerName }}</span>
              </td>
            </ng-container>

            <!-- Location Column -->
            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef>Ziel</th>
              <td mat-cell *matCellDef="let order">
                <div class="location-cell">
                  <span class="country-flag" [matTooltip]="order.customerCountry">{{ order.countryFlag }}</span>
                  <span class="city-name">{{ order.customerCity || '—' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Product Column -->
            <ng-container matColumnDef="product">
              <th mat-header-cell *matHeaderCellDef>Produkt</th>
              <td mat-cell *matCellDef="let order" (click)="$event.stopPropagation()">
                <div class="product-cell">
                  <a *ngIf="order.prodfluxId"
                     [routerLink]="['/products', order.prodfluxId]"
                     class="product-link"
                     [matTooltip]="'WooCommerce: ' + order.wcProductName">
                    <mat-icon class="link-icon">inventory_2</mat-icon>
                    {{ order.productShortName }}
                  </a>
                  <span *ngIf="!order.prodfluxId"
                        class="product-unmatched"
                        [matTooltip]="'Nicht gemappt: ' + order.wcProductName">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    {{ order.productShortName }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Stock Column -->
            <ng-container matColumnDef="stock">
              <th mat-header-cell *matHeaderCellDef>Bestand</th>
              <td mat-cell *matCellDef="let order">
                <div *ngIf="order.prodfluxId" class="stock-cell">
                  <span
                    *ngFor="let stock of getStocksList(order.stocks)"
                    class="stock-item"
                    [class.no-stock]="stock.bestand === 0">
                    <span class="workshop-name">{{ stock.shortName }}:</span>
                    <span class="stock-value">{{ stock.bestand }}</span>
                  </span>
                  <span *ngIf="getStocksList(order.stocks).length === 0" class="stock-unknown">—</span>
                </div>
                <span *ngIf="!order.prodfluxId" class="stock-unknown">—</span>
              </td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Menge</th>
              <td mat-cell *matCellDef="let order">
                <span class="quantity-badge">{{ order.quantity }}x</span>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let order">
                <span class="status-badge" [style.--status-color]="order.statusColor">
                  <mat-icon>{{ order.statusIcon }}</mat-icon>
                  {{ order.statusLabel }}
                </span>
              </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Gesamtpreis</th>
              <td mat-cell *matCellDef="let order">
                <span class="price">{{ formatCurrency(order.total, order.currency) }}</span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let order">
                <a
                  mat-icon-button
                  [routerLink]="['/dashboard/shopbridge-orders', order.orderId]"
                  matTooltip="Details anzeigen">
                  <mat-icon>visibility</mat-icon>
                </a>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                [routerLink]="['/dashboard/shopbridge-orders', row.orderId]"
                class="clickable-row"></tr>
          </table>

          <!-- Empty State -->
          <div *ngIf="filteredOrders.length === 0" class="empty-state">
            <mat-icon>inbox</mat-icon>
            <p>Keine Bestellungen mit diesem Filter gefunden.</p>
            <button mat-stroked-button (click)="setStatusFilter(null)">
              Filter zurücksetzen
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
