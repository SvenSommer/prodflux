<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #login-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 1000;
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        
        #login-panel.logged-in {
            background: #e8f5e9;
        }
        
        #login-panel h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }
        
        #login-panel input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        #login-panel button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }
        
        #login-btn {
            background: #4caf50;
            color: white;
        }
        
        #login-btn:hover {
            background: #45a049;
        }
        
        #logout-btn {
            background: #f44336;
            color: white;
            margin-top: 10px;
        }
        
        #logout-btn:hover {
            background: #da190b;
        }
        
        #login-status {
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        #user-info {
            font-size: 13px;
            color: #155724;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Panel -->
    <div id="login-panel">
        <h3>üîê Quick Login</h3>
        <div id="login-status" class="hidden"></div>
        <div id="user-info" class="hidden"></div>
        <div id="login-form">
            <input type="text" id="username" placeholder="Username" autocomplete="username">
            <input type="password" id="password" placeholder="Password" autocomplete="current-password">
            <button id="login-btn" onclick="login()">Login & Authorize</button>
        </div>
        <button id="logout-btn" class="hidden" onclick="logout()">Logout</button>
    </div>

    <!-- Swagger UI -->
    <div id="swagger-ui"></div>

    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui-standalone-preset.js"></script>
    <script>
        // Configuration
        const API_BASE_URL = window.location.origin;
        const LOGIN_URL = API_BASE_URL + '/api/auth/login/';
        
        // Initialize Swagger UI
        const ui = SwaggerUIBundle({
            url: "{{ schema_url }}",
            dom_id: '#swagger-ui',
            deepLinking: true,
            presets: [
                SwaggerUIBundle.presets.apis,
                SwaggerUIStandalonePreset
            ],
            plugins: [
                SwaggerUIBundle.plugins.DownloadUrl
            ],
            layout: "StandaloneLayout",
            persistAuthorization: true,
            onComplete: function() {
                // Check if we have a stored token
                const storedToken = localStorage.getItem('jwt_token');
                const storedUser = localStorage.getItem('username');
                if (storedToken && storedUser) {
                    setAuthToken(storedToken);
                    showLoggedInState(storedUser);
                }
            }
        });

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('Please enter username and password', 'error');
                return;
            }
            
            showStatus('Logging in...', 'info');
            
            try {
                const response = await fetch(LOGIN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const token = data.access;
                    
                    // Store token and username
                    localStorage.setItem('jwt_token', token);
                    localStorage.setItem('username', username);
                    
                    // Set authorization in Swagger UI
                    setAuthToken(token);
                    
                    // Update UI
                    showLoggedInState(username);
                    showStatus('‚úì Logged in successfully! Token set in Swagger UI', 'success');
                    
                    // Clear password
                    document.getElementById('password').value = '';
                } else {
                    const error = await response.json();
                    showStatus('Login failed: ' + (error.detail || 'Invalid credentials'), 'error');
                }
            } catch (error) {
                showStatus('Login error: ' + error.message, 'error');
            }
        }
        
        // Logout function
        function logout() {
            // Clear stored data
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('username');
            
            // Clear authorization in Swagger UI
            ui.preauthorizeApiKey("Bearer", "");
            
            // Update UI
            showLoggedOutState();
            showStatus('Logged out successfully', 'info');
        }
        
        // Set auth token in Swagger UI
        function setAuthToken(token) {
            // Set Bearer token
            ui.preauthorizeApiKey("Bearer", token);
        }
        
        // Show logged in state
        function showLoggedInState(username) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-info').textContent = 'üë§ Logged in as: ' + username;
            document.getElementById('login-panel').classList.add('logged-in');
        }
        
        // Show logged out state
        function showLoggedOutState() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-panel').classList.remove('logged-in');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('login-status');
            statusDiv.textContent = message;
            statusDiv.className = 'status-' + type;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Allow login with Enter key
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });
    </script>
</body>
</html>
