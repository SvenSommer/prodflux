<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
<div class="page-container">
  <div class="workshop-container" *ngIf="workshop">
    <mat-card class="workshop-header">
      <mat-card-title>{{ workshop.name }}</mat-card-title>

      <app-product-overview
      [products]="productLifecycle"
      (planMultiOrder)="openMultiOrderModal()"
      (openOrder)="openOrderModal($event)"
      (openSell)="openSellDialog($event)"
      (manufacture)="manufactureProductFromChild($event)"
    ></app-product-overview>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Aktueller Materialbestand</mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Inventurmodus Toggle -->
        <div class="inventory-toggle-section">
          <mat-slide-toggle
            [checked]="inventoryMode"
            (change)="toggleInventoryMode()"
            color="primary">
            Inventurmodus
          </mat-slide-toggle>
          <span class="inventory-help-text" *ngIf="inventoryMode">
            <mat-icon>info</mat-icon>
            Geben Sie die tatsächlich gezählten Mengen ein. Korrekturen werden automatisch berechnet.
          </span>
          <button
            *ngIf="inventoryMode && !inventoryNavigationMode"
            mat-raised-button
            color="accent"
            (click)="startInventoryNavigation()"
            [disabled]="allMaterials.length === 0"
          >
            <mat-icon>navigate_next</mat-icon>
            Inventur starten (alle Materialien)
          </button>
        </div>

        <ng-container *ngFor="let group of stock">
          <h4 class="category-title">{{ group.category_name }}</h4>

          <table
            mat-table
            [dataSource]="group.materials"
            class="mat-elevation-z1 full-width-table mt-2"
          >
            <!-- Nr -->
            <ng-container matColumnDef="nr">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let element; let i = index">
                {{ i + 1 }}
              </td>
            </ng-container>

            <!-- Bild -->
            <ng-container matColumnDef="bild">
              <th mat-header-cell *matHeaderCellDef>Bild</th>
              <td mat-cell *matCellDef="let element">
                <img
                  *ngIf="element.bild_url"
                  [src]="element.bild_url"
                  alt="Bild"
                  class="table-image"
                />
              </td>
            </ng-container>

            <!-- Bezeichnung -->
            <ng-container matColumnDef="bezeichnung">
              <th mat-header-cell *matHeaderCellDef>Material</th>
              <td mat-cell *matCellDef="let element">
                <a [routerLink]="['/materials', element.id]">
                  {{ element.bezeichnung }}
                </a>
              </td>
            </ng-container>

            <!-- Bestand -->
            <ng-container matColumnDef="bestand">
              <th mat-header-cell *matHeaderCellDef>Bestand</th>
              <td mat-cell *matCellDef="let element">{{ element.bestand }}</td>
            </ng-container>

            <!-- Inventurmenge (nur im Inventurmodus) -->
            <ng-container matColumnDef="inventurmenge" *ngIf="inventoryMode">
              <th mat-header-cell *matHeaderCellDef>Gezählt</th>
              <td mat-cell *matCellDef="let element">
                <mat-form-field appearance="outline" class="inventory-input">
                  <input
                    matInput
                    type="number"
                    min="0"
                    [(ngModel)]="inventoryCounts[element.id]"
                    placeholder="Gezählte Menge"
                  />
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Inventur-Aktionen (nur im Inventurmodus) -->
            <ng-container matColumnDef="inventur-aktionen" *ngIf="inventoryMode">
              <th mat-header-cell *matHeaderCellDef>Aktion</th>
              <td mat-cell *matCellDef="let element">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="saveInventoryCorrection(element.id, element.bezeichnung)"
                  matTooltip="Inventurkorrektur speichern"
                >
                  <mat-icon>save</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Header und Row-Definitionen -->
            <tr mat-header-row *matHeaderRowDef="getDisplayedColumns()"></tr>
            <tr mat-row *matRowDef="let row; columns: getDisplayedColumns();"></tr>
          </table>
        </ng-container>

        <!-- Inventur-Aktionsleiste -->
        <div class="inventory-actions" *ngIf="inventoryMode">
          <button
            mat-raised-button
            color="primary"
            (click)="saveAllInventoryCorrections()"
            [disabled]="getInventoryCountsLength() === 0"
          >
            <mat-icon>inventory</mat-icon>
            Alle Inventurkorrekturen speichern
          </button>
          <span class="inventory-info">
            {{ getInventoryCountsLength() }} Materialien erfasst
          </span>
        </div>

      </mat-expansion-panel>
    </mat-card>

    <!-- Modal für Material Bestellung mehrerer Produkte-->

    <ng-template #multiOrderDialog let-dialog>
      <h2 mat-dialog-title>Materialbedarf planen und bestellen</h2>
      <mat-dialog-content class="multi-dialog-content">

        <!-- Produktmenge pro Produkt -->
        <table class="full-width-table">
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Menge</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let entry of multiOrderProducts">
              <td>{{ entry.product }}</td>
              <td>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    type="number"
                    min="0"
                    [(ngModel)]="entry.quantity"
                    (ngModelChange)="loadAggregatedRequirements()"
                  />
                </mat-form-field>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Fehlende Materialien -->
        <h3 class="mt-4">Fehlende Materialien</h3>
        <table class="full-width-table mt-2">
          <thead>
            <tr>
              <th>Bild</th>
              <th>Material</th>
              <th>Benötigt</th>
              <th>Bestellt</th>
              <th>Vorhanden</th>
              <th>Fehlend</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!filteredMissingRequirements.length">
              <td colspan="6" class="text-center text-gray-500 py-2">
                Keine fehlenden Materialien.
              </td>
            </tr>
            <tr *ngFor="let req of filteredMissingRequirements">
              <td>
                <img
                  *ngIf="req.bild_url"
                  [src]="req.bild_url"
                  alt="{{ req.bezeichnung }}"
                  class="table-image small"
                />
              </td>
              <td>{{ req.bezeichnung }}</td>
              <td>{{ req.required_quantity }}</td>
              <td>{{ req.ordered_quantity }}</td>
              <td>{{ req.available_quantity }}</td>
              <td>{{ req.missing_quantity }}</td>
            </tr>
          </tbody>
        </table>

        <!-- Bereits gedeckte Materialien -->
        <h3 class="mt-6">Bereits gedeckte Materialien</h3>
        <table class="full-width-table mt-2">
          <thead>
            <tr>
              <th>Bild</th>
              <th>Material</th>
              <th>Benötigt</th>
              <th>Bestellt</th>
              <th>Vorhanden</th>
              <th>Fehlend</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!filteredCoveredRequirements.length">
              <td colspan="6" class="text-center text-gray-500 py-2">
                Keine vollständig gedeckten Materialien.
              </td>
            </tr>
            <tr *ngFor="let req of filteredCoveredRequirements">
              <td>
                <img
                  *ngIf="req.bild_url"
                  [src]="req.bild_url"
                  alt="{{ req.bezeichnung }}"
                  class="table-image small"
                />
              </td>
              <td>{{ req.bezeichnung }}</td>
              <td>{{ req.required_quantity }}</td>
              <td>{{ req.ordered_quantity }}</td>
              <td>{{ req.available_quantity }}</td>
              <td>{{ req.missing_quantity }}</td>
            </tr>
          </tbody>
        </table>

      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Schließen</button>
        <button
          mat-raised-button
          color="primary"
          [disabled]="!filteredMissingRequirements.length"
          (click)="confirmAggregatedOrder(dialog)"
        >
          Bestellen
        </button>
      </mat-dialog-actions>
    </ng-template>
  </div>

  <div *ngIf="!workshop">
    <p class="text-center">Werkstatt nicht gefunden.</p>
  </div>

  <!-- Inventur-Navigation Widget -->
  <div class="inventory-navigation" *ngIf="inventoryNavigationMode && getCurrentMaterial()">
    <div class="nav-header">
      <h4>Inventur</h4>
      <span class="nav-progress">{{ getInventoryProgress() }}</span>
    </div>

    <div class="current-material">
      <!-- Material Bild -->
      <div class="material-image-container" *ngIf="getCurrentMaterial().bild_url">
        <img
          [src]="getCurrentMaterial().bild_url"
          [alt]="getCurrentMaterial().bezeichnung"
          class="material-image"
          (error)="onImageError($event)"
        />
      </div>
      <div class="material-placeholder" *ngIf="!getCurrentMaterial().bild_url">
        <mat-icon>image_not_supported</mat-icon>
      </div>

      <div class="material-info">
        <div class="material-name">{{ getCurrentMaterial().bezeichnung }}</div>
        <div class="current-stock">
          Kategorie: {{ getCurrentMaterial().categoryName }}<br>
          Aktueller Bestand: {{ getCurrentMaterial().bestand }}
        </div>
      </div>

      <mat-form-field appearance="outline" class="inventory-input-large">
        <mat-label>Gezählte Menge</mat-label>
        <input
          matInput
          type="number"
          min="0"
          [(ngModel)]="inventoryCounts[getCurrentMaterial().id]"
          (keydown)="onInventoryKeyPress($event)"
          placeholder="Eingeben..."
        />
      </mat-form-field>
    </div>

    <div class="nav-actions">
      <button
        mat-button
        (click)="goToPreviousMaterial()"
        [disabled]="currentMaterialIndex === 0"
      >
        <mat-icon>chevron_left</mat-icon>
        Zurück
      </button>

      <button
        mat-raised-button
        color="primary"
        (click)="saveCurrentAndNext()"
        [disabled]="inventoryCounts[getCurrentMaterial().id] === undefined"
      >
        <mat-icon>save</mat-icon>
        Speichern & Weiter
      </button>

      <button
        mat-button
        (click)="goToNextMaterial()"
        [disabled]="currentMaterialIndex >= allMaterials.length - 1"
      >
        Weiter
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <button
      mat-stroked-button
      color="accent"
      class="finish-inventory"
      (click)="finishInventoryNavigation()"
    >
      <mat-icon>done</mat-icon>
      Inventur beenden
    </button>
  </div>

  <!-- Inventur Abschluss Dialog -->
  <ng-template #inventoryCompletionDialog>
    <h2 mat-dialog-title>
      <mat-icon>inventory</mat-icon>
      Inventur abgeschlossen
    </h2>
    <mat-dialog-content>
      <p>Die Inventur wurde erfolgreich abgeschlossen.</p>
      <div class="inventory-summary">
        <p><strong>{{ inventoryDialogData.processedCount }}</strong> Materialien wurden bearbeitet</p>
        <p><strong>{{ inventoryDialogData.savedCount }}</strong> Inventurkorrekturen wurden gespeichert</p>
        <p class="total-count">von insgesamt {{ inventoryDialogData.totalCount }} Materialien</p>
      </div>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-raised-button color="primary" mat-dialog-close>
        <mat-icon>check</mat-icon>
        OK
      </button>
    </mat-dialog-actions>
  </ng-template>
</div>
