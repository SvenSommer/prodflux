<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
<div class="page-container">
  <div class="workshop-container" *ngIf="!isLoading && workshop">
    <mat-card class="workshop-header">
      <mat-card-title>{{ workshop.name }}</mat-card-title>

      <app-product-overview
      [products]="productLifecycle"
      (planMultiOrder)="openMultiOrderModal()"
      (openOrder)="openOrderModal($event)"
      (openSell)="openSellDialog($event)"
      (manufacture)="manufactureProductFromChild($event)"
    ></app-product-overview>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <span>Aktueller Materialbestand</span>
            <div class="header-toggles" (click)="$event.stopPropagation()">
              <mat-slide-toggle
                [checked]="(inventoryService.state$ | async)?.isActive || false"
                (change)="onInventoryModeToggle()"
                color="primary"
                class="inventory-toggle-inline"
              >
                Inventur
              </mat-slide-toggle>
              <mat-slide-toggle
                [(ngModel)]="includeDeprecatedMaterials"
                (ngModelChange)="onToggleDeprecatedMaterials()"
                color="accent"
                class="deprecated-toggle-inline"
              >
                Veraltete anzeigen
              </mat-slide-toggle>
            </div>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Inventur-Aktionen (nur wenn Inventurmodus aktiv) -->
        <app-inventory-controls
          [inventoryModeActive]="(inventoryService.state$ | async)?.isActive || false"
          [navigationModeActive]="(inventoryService.state$ | async)?.isNavigationMode || false"
          [materialCount]="allMaterials.length"
          [unsavedCount]="getUnsavedInventoryCount()"
          [showToggle]="false"
          (inventoryModeToggled)="onInventoryModeToggle()"
          (navigationStarted)="onStartInventoryNavigation()"
          (saveAllRequested)="onSaveAllInventoryCorrections()"
        ></app-inventory-controls>

        <!-- Material Inventory Table -->
        <app-material-inventory-table
          [materialGroups]="stock"
          [inventoryModeActive]="(inventoryService.state$ | async)?.isActive || false"
          [inventoryCounts]="(inventoryService.state$ | async)?.inventoryCounts || {}"
          [savedMaterialIds]="(inventoryService.state$ | async)?.savedMaterialIds || emptySavedMaterialIds"
          (inventoryCountChanged)="onInventoryCountChange($event)"
          (saveCorrectionRequested)="onSaveCorrection($event)"
        ></app-material-inventory-table>

      </mat-expansion-panel>
    </mat-card>

    </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Werkstatt wird geladen...</p>
  </div>

  <!-- Workshop not found State -->
  <div *ngIf="!isLoading && !workshop" class="error-container">
    <p class="error-text">Werkstatt nicht gefunden.</p>
  </div>

  <!-- Inventur-Navigator Widget -->
  <app-inventory-navigator
    [workshopId]="workshopId"
    [stock]="stock"
    (stockUpdated)="onStockUpdated()"
  ></app-inventory-navigator>


</div>
