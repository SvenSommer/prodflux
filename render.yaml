services:
  - type: web
    name: prodflux-backend
    runtime: python
    buildCommand: |
      # Install Python dependencies
      pip install -r requirements.txt
      # Install Node.js and npm for Angular build
      curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      apt-get install -y nodejs
      # Build Angular frontend
      cd prodflux-frontend
      npm install
      ng build --configuration=production
      cd ..
      # Collect static files including built frontend
      python manage.py collectstatic --noinput
      # Verify frontend files are collected
      ls -la staticfiles/ || echo "staticfiles directory not found"
      ls -la staticfiles/index.html || echo "index.html not found in static files"
    startCommand: gunicorn prodflux.wsgi:application --bind=0.0.0.0:$PORT
    envVars:
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        generateValue: true
      - key: RENDER
        value: "True"
      - key: RENDER_EXTERNAL_HOSTNAME
        value: "prodflux.onrender.com"