<div class="page-container">
  <app-breadcrumb
    [links]="[{ label: 'Bestellungen', url: '/orders' }]"
  ></app-breadcrumb>

  <div class="orders-table-wrapper">
    <div class="header-row">
      <h2>Bestellungen</h2>
      <a routerLink="/orders/new">
        <button mat-raised-button color="primary">
          <mat-icon>add</mat-icon>
          Neue Bestellung
        </button>
      </a>
    </div>

    <table
      mat-table
      [dataSource]="orders"
      class="mat-elevation-z1 full-width-table clickable-table"
      multiTemplateDataRows
    >
      <!-- ID -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let o">{{ o.id }}</td>
      </ng-container>

      <!-- Supplier -->
      <ng-container matColumnDef="supplier">
        <th mat-header-cell *matHeaderCellDef>Lieferant</th>
        <td mat-cell *matCellDef="let o">{{ getSupplierName(o.supplier) }}</td>
      </ng-container>

      <!-- Bestellt am -->
      <ng-container matColumnDef="bestellt_am">
        <th mat-header-cell *matHeaderCellDef>Bestellt am</th>
        <td mat-cell *matCellDef="let o">{{ formatDate(o.bestellt_am) }}</td>
      </ng-container>

      <!-- Angekommen am -->
      <ng-container matColumnDef="angekommen_am">
        <th mat-header-cell *matHeaderCellDef>Angekommen am</th>
        <td mat-cell *matCellDef="let o">{{ formatDate(o.angekommen_am) }}</td>
      </ng-container>

      <!-- Historisch -->
      <ng-container matColumnDef="is_historical">
        <th mat-header-cell *matHeaderCellDef>Historisch</th>
        <td mat-cell *matCellDef="let o">
          <mat-icon *ngIf="o.is_historical" class="historical-icon" title="Historische Bestellung - keine Auswirkung auf Materialbestand">
            history
          </mat-icon>
        </td>
      </ng-container>

      <!-- Notiz -->
      <ng-container matColumnDef="notiz">
        <th mat-header-cell *matHeaderCellDef>Notiz</th>
        <td mat-cell *matCellDef="let o">{{ o.notiz || "â€”" }}</td>
      </ng-container>

      <!-- Materialien -->
      <ng-container matColumnDef="materials">
        <th mat-header-cell *matHeaderCellDef>Materialien</th>
        <td mat-cell *matCellDef="let o" (click)="$event.stopPropagation()">
          <div class="materials-list">
            <button
              mat-button
              (click)="toggleOrderExpansion(o.id, $event)"
              class="materials-toggle-btn">
              <mat-icon>{{ isOrderExpanded(o.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
              {{ getMaterialsList(o.items) }}
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Expanded Row for Material Details -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let o" [attr.colspan]="8">
          <div class="expanded-row-container"
               [@detailExpand]="isOrderExpanded(o.id) ? 'expanded' : 'collapsed'"
               (click)="$event.stopPropagation()">
            <div class="materials-detail-wrapper">
              <app-material-table
                [rows]="getMaterialTableRows(o)"
                [columns]="materialTableColumns"
                [showImage]="true"
                [showCategory]="true">
                <ng-template #customColumn let-row let-column="column">
                  @switch (column.key) {
                    @case ('quantity') {
                      {{ row.data.quantity | number:'1.0-2' }}
                    }
                    @case ('preis_pro_stueck') {
                      {{ formatCurrency(row.data.preis_pro_stueck) }}
                    }
                    @case ('mwst_satz') {
                      {{ row.data.mwst_satz }}%
                    }
                    @case ('gesamt') {
                      <strong>{{ formatCurrency(row.data.gesamt) }}</strong>
                    }
                  }
                </ng-template>
              </app-material-table>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Gesamtkosten -->
      <ng-container matColumnDef="total_cost">
        <th mat-header-cell *matHeaderCellDef>Gesamtkosten</th>
        <td mat-cell *matCellDef="let o">
          <strong>{{ formatCurrency(calculateTotalCost(o)) }}</strong>
        </td>
      </ng-container>

      <!-- Versandkosten -->
      <ng-container matColumnDef="versandkosten">
        <th mat-header-cell *matHeaderCellDef>Versandkosten</th>
        <td mat-cell *matCellDef="let o">
          {{ formatCurrency(o.versandkosten) }}
        </td>
      </ng-container>

      <tr
        mat-header-row
        *matHeaderRowDef="[
          'id',
          'supplier',
          'bestellt_am',
          'angekommen_am',
          'is_historical',
          'materials',
          'total_cost',
          'notiz'
        ]"
      ></tr>
      <tr
        mat-row
        *matRowDef="
          let row;
          columns: [
            'id',
            'supplier',
            'bestellt_am',
            'angekommen_am',
            'is_historical',
            'materials',
            'total_cost',
            'notiz'
          ];
        "
        (click)="navigateToDetail(row.id)"
        class="clickable-row"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="expanded-detail-row">
      </tr>
    </table>
  </div>
</div>
